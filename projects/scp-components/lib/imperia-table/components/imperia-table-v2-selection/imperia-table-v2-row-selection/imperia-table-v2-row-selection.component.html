<ng-container
  *ngIf="{
    selection: (selection$ | async)!,
    copying: (copyingRows$ | async)!,
  } as vm"
>
  <ng-template #copyTemplate imperiaTableBodyCellContextMenuTemplate let-ctx>
    <!-- COPY ROW -->
    <ng-container
      *ngTemplateOutlet="
        copyButtonTemplate;
        context: {
          $implicit: vm,
          config: {
            text: 'IMPERIA_TABLE.rows.context_menu.copy_row' | impTranslate,
            items: [ctx.row.data],
            from: 'row',
          },
        }
      "
    ></ng-container>
    <div class="separator horizontal my-1"></div>
    <!-- COPY SELECTED ROWS -->
    <ng-container
      *ngTemplateOutlet="
        copyButtonTemplate;
        context: {
          $implicit: vm,
          config: {
            text:
              !!vm.copying.state && vm.copying.from == 'selection'
                ? ('IMPERIA_TABLE.rows.context_menu.copying_selection'
                  | impTranslate
                    : {
                        currentRowNumBeingCopied:
                          currentRowCountBeingCopied$ | async,
                        totalRowsToCopy: vm.copying.totalRowsToCopy,
                      })
                : ('IMPERIA_TABLE.rows.context_menu.copy_selection'
                  | impTranslate
                    : {
                        selectedRowsNumber: vm.selection.length,
                      }),
            items: vm.selection,
            from: 'selection',
          },
        }
      "
    ></ng-container>
  </ng-template>
</ng-container>

<ng-template
  #copyButtonTemplate
  imperiaTableV2RowSelectionContextMenuButtonTemplate
  let-ctx
  let-config="config"
>
  <imperia-icon-button
    type="button"
    [icon]="
      ctx.copying.result == null
        ? 'copy'
        : ctx.copying.from == config.from
          ? ctx.copying.result
            ? 'check'
            : 'x'
          : null
    "
    [containerSize]="29"
    [loading]="!!ctx.copying.state && ctx.copying.from == config.from"
    [disabled]="
      ctx.copying.state ||
      !ctx.selection.length ||
      (ctx.copying.result != null && ctx.copying.from == config.from)
    "
    [text]="config.text"
    (onClick)="
      onCopyRows.next({
        items: config.items,
        from: config.from,
      })
    "
  ></imperia-icon-button>
</ng-template>

<table #tableToCopyRows class="to-copy-rows">
  <ng-container *ngIf="tableToCopyRowsVM$ | async as tableToCopyRowsVM">
    <ng-container *ngIf="tableToCopyRowsVM.from != null">
      <tr *ngIf="rowToCopyRendered$ | async as row">
        <td
          *ngFor="
            let col of tableToCopyRowsVM.columns;
            let colIndex = index;
            trackBy: table.colTrackByFn
          "
        >
          <ng-container
            *ngIf="{
              col: col,
              row: row,
              cell: row.cells[col.field],
            } as ctx"
          >
            <ng-template
              *ngTemplateOutlet="
                ctx.col.bodyCellTemplate ?? table.bodyCellContentTemplate;
                context: { $implicit: $any(ctx) }
              "
            ></ng-template>
          </ng-container>
        </td>
      </tr>
    </ng-container>
  </ng-container>
</table>
